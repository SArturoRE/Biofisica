<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Subir archivos</title>

    <!-- indexJS -->
    <script src="js/index.js"></script>

    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>

    <!-- Popper -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>

    <!--Llamado a scrips de bodstrap-->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

</head>

<body>

    <nav class="navbar navbar-dark bg-dark navbar-expand-sm">
        <div class="container">
            <a class="navbar-brand" href="/Biofisica/">
                <img src="img/logo_biofisica.png" width="100" alt="logo_biofisica">
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-list-11"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbar-list-11">
                <ul class="navbar-nav ml-auto ">
                </ul>
            </div>
        </div>
    </nav>

    <div class="plantilla_MaterialApoyo shadow p-3 mb-5 bg-white rounded" style="margin: 1vw;" hidden>
        <div class="body_plantilla_MaterialApoyo">
            <iframe src="" width='400' height='300' allowfullscreen
                webkitallowfullscreen></iframe>
        </div>
        <div class="footer_plantilla_MaterialApoyo" style="display: flex; justify-content: space-around;">
            <button class="btn btn-outline-dark">mostrar al alumno</button>
            <button class="btn btn-outline-dark">eliminar</button>
        </div>
    </div>

    <div class="materialApoyo">
        <div class="header_materialApoyo_archivos  shadow p-3 mb-5 bg-white rounded"
            style="margin: 10vh 0; margin: 5vw;">
            <div>
                <p style="text-align: center; font-size: 3em;">Agregar Nuevo Archivo</p>
            </div>
            <div style="display: flex; justify-content: center;">
                <input type="file" name="" id="addNewFile">
                <button class="btn btn-success" onclick="subirArchivo();">agregar archivo</button>
            </div>
            <div class="div_tipoArchivo" style="display: flex; justify-content: center;margin: 3vh 0;">
                <input type="radio" name="tipoArchivo" value="vistoClase" style="height: 30px; width: 20px;">
                <label for="">Visto en Clase</label>

                <input type="radio" name="tipoArchivo" value="materialExterno" style="height: 30px; width: 20px;">
                <label for="">Material Externo</label>
            </div>
        </div>
        <div class="materialApoyo_archivos" style="display: flex;">
            <div class="vistos_en_clase" style="text-align: center; width: 50vw;">
                <header style="font-size: 2em;">Visto en Clase</header>
            </div>
            <div class="externo" style="text-align: center; width: 50vw;">
                <header style="font-size: 2em;">Material Externo</header>
            </div>
        </div>

    </div>

    <script type="text/javascript">
    
        // archivo a subir
        var newFile_to_Upload = null;

        window.onload = function(){
            document.querySelector("#addNewFile").addEventListener("change", function(){
                if(this.files.length == 0) return;
                newFile_to_Upload = this.files[0];
            });

            obtenArchivosServidor();
        }

        function obtenArchivosServidor(){
            let plantilla_MaterialApoyo = document.querySelector(".plantilla_MaterialApoyo");
            let iframe = plantilla_MaterialApoyo.querySelector("iframe");
        }

        function subirArchivo(){
            var tipoArchivo = document.querySelector("input[name='tipoArchivo']:checked");

            if(tipoArchivo == null || newFile_to_Upload == null || newFile_to_Upload.type != "application/pdf"){
                if(newFile_to_Upload == null){
                    // mensaje de error
                    alert("elige un archivo");
                }

                if(newFile_to_Upload.type != "application/pdf"){
                    // mensaje de error
                    alert("seleciona un archivo pdf valido");
                }
                
                if(tipoArchivo == null){
                    // mensaje de error
                    alert("elige una opcion");
                }
                return;
            }

            console.log("enviando");

            let formData = new FormData();
            formData.append("filePDF", newFile_to_Upload);
            formData.append("tipo", tipoArchivo.value);
            let request = new XMLHttpRequest();
            request.open("post", "php/subirMaterialApoyo.php");

            request.send(formData);
            request.onload = function(){
                if(request.status != 200){
                    alert(`Error ${request.status}: ${request.statusText}`);
                } else {

                    let responseText = JSON.parse(request.responseText);
                    if(responseText["error"] != undefined) {
                        alert("mensaje de error");
                    } else {
                        let name = responseText["name"];
                        let tipo = responseText["tipo"];
                        agrega_MaterialApoyo(name, tipo);
                    }
                }
            }

            request.onerror = function(){
                alert("error inesperado al subir el archivo pdf al servidor sorry :,v");
            }
            request.onprogress = function (event) { // triggers periodically
                // event.loaded - how many bytes downloaded
                // event.lengthComputable = true if the server sent Content-Length header
                // event.total - total number of bytes (if lengthComputable)
                console.log(`Received ${event.loaded} of ${event.total}`);
            };
        }

        function agrega_MaterialApoyo(name, tipo){
            let plantilla_MaterialApoyo = document.querySelector(".plantilla_MaterialApoyo");
            let iframe = plantilla_MaterialApoyo.querySelector("iframe");
            iframe.src = "./ViewerJS/#../materialApoyo/" + name;
            let div_plantilla_MaterialApoyo = document.createElement("div");
            div_plantilla_MaterialApoyo.innerHTML = plantilla_MaterialApoyo.innerHTML;

            if(tipo == "vistoClase") {
                var material = document.querySelector(".vistos_en_clase");
            } else {
                var material = document.querySelector(".materialApoyo_archivos").querySelector(".externo");
            }

            material.insertAdjacentElement("beforeend", div_plantilla_MaterialApoyo);
        }
    </script>

</body>

</html>